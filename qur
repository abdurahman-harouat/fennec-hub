#!/bin/bash

set -e

REPO_BASE_URL="https://raw.githubusercontent.com/abdurahman-harouat/qalaa-repo/main/source_files"

usage() {
    echo "Usage: qur -i <package_name>"
    echo "  -i    Install the specified package"
    echo "  -h    Display this help message"
}

download_file() {
    local url="$1"
    local output_file="$2"
    
    if command -v curl &> /dev/null; then
        curl -s -o "$output_file" "$url"
    elif command -v wget &> /dev/null; then
        wget -q -O "$output_file" "$url"
    else
        echo "Error: Neither curl nor wget is available. Please install one of them."
        return 1
    fi
}

install_package() {
    local package=$1
    local temp_dir=$(mktemp -d)
    
    echo "Preparing to install $package..."
    
    # Download the OOO file
    echo "Downloading package information..."
    if ! download_file "$REPO_BASE_URL/$package/OOO" "$temp_dir/OOO"; then
        rm -rf "$temp_dir"
        exit 1
    fi
    
    if [ ! -f "$temp_dir/OOO" ]; then
        echo "Error: Unable to download package information for $package"
        rm -rf "$temp_dir"
        exit 1
    fi
    
    # Change to the temp directory
    cd "$temp_dir"
    
    # Run paqager with the freshly downloaded OOO file
    echo "Building and installing $package..."
    bash -c "source ./OOO && paqager"
    
    # Clean up
    cd - > /dev/null
    rm -rf "$temp_dir"

}

# Main script logic
if [ $# -eq 0 ]; then
    usage
    exit 1
fi

while getopts "hi:" opt; do
    case ${opt} in
        h )
            usage
            exit 0
            ;;
        i )
            package=$OPTARG
            install_package "$package"
            ;;
        \? )
            usage
            exit 1
            ;;
    esac
done