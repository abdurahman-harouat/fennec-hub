#!/bin/bash

# LFS Build Script

set -e

PKGINFO_FILE="${PWD}/OOO"

if [ ! -f "$PKGINFO_FILE" ]; then
    echo "Error: Package info file 'OOO' not found in the current directory."
    exit 1
fi

source "$PKGINFO_FILE"

# Download function
download() {
    echo "Downloading ${pkgname}-${pkgver}..."
    wget "${source}"
}

# Verify function
verify() {
    downloaded_file=$(basename "${source}")
    echo "Verifying MD5 checksum..."
    echo "${md5sum}  ${downloaded_file}" | md5sum -c --status
    if [ $? -ne 0 ]; then
        echo "MD5 checksum verification failed. Aborting."
        exit 1
    fi
}

# Main execution
echo "Building package: ${pkgname}-${pkgver}"

download
verify

if [ "$(type -t prepare)" = function ]; then
    echo "Preparing..."
    prepare
fi

if [ "$(type -t build)" = function ]; then
    echo "Building..."
    build
fi

if [ "$(type -t install)" = function ]; then
    echo "Installing..."
    install
fi

if [ "$(type -t clean)" = function ]; then
    echo "Cleaning..."
    clean
fi

LOGFILE="/var/log/packages.log"

# Log the installation
echo "${pkgname} ${pkgver} installed on $(date)" >> ${LOGFILE}

echo "Package ${pkgname}-${pkgver} has been successfully built and installed."
